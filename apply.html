<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hackathon Application</title>
    <link rel="stylesheet" href="apply_form_styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Hackathon Application</h1>
            <p id="hackathon-title">Loading hackathon details...</p>
        </header>

        <section class="application-form-section">
            <form id="application-form">
                <!-- 1. Personal Information Section -->
                <h2 class="form-section-title">Personal Information</h2>
                
                <div class="form-group">
                    <label for="full-name">Full Name*</label>
                    <input type="text" id="full-name" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address*</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number*</label>
                    <input type="tel" id="phone" required>
                </div>
                
                <div class="form-group">
                    <label for="linkedin">LinkedIn Profile (optional)</label>
                    <input type="url" id="linkedin" placeholder="https://www.linkedin.com/in/yourprofile">
                </div>
                
                <div class="form-group">
                    <label for="github">GitHub/Portfolio (optional)</label>
                    <input type="url" id="github" placeholder="https://github.com/yourusername">
                </div>
                
                <div class="form-group">
                    <label for="resume">Resume (PDF)*</label>
                    <input type="file" id="resume" accept=".pdf" required>
                    <small>Maximum file size: 5MB</small>
                </div>
                
                <!-- 2. Team Information Section -->
                <h2 class="form-section-title">Team Information</h2>
                
                <div class="form-group">
                    <label>Are you applying as an individual or in a team?*</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="application-type" value="individual" required> Individual
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="application-type" value="team"> Team
                        </label>
                    </div>
                </div>
                
                <div id="team-fields" style="display: none;">
                    <div class="form-group">
                        <label for="team-name">Team Name*</label>
                        <input type="text" id="team-name">
                    </div>
                    
                    <div class="form-group">
                        <label for="team-size">Team Size*</label>
                        <select id="team-size">
                            <option value="">Select team size</option>
                            <option value="1">Solo (1 person)</option>
                            <option value="2">2 people</option>
                            <option value="3">3 people</option>
                            <option value="4">4 people</option>
                            <option value="5">5 people</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="team-members">Names & Emails of Team Members*</label>
                        <textarea id="team-members" rows="4" placeholder="Name 1 - email1@example.com&#10;Name 2 - email2@example.com"></textarea>
                        <small>One team member per line, format: Name - Email</small>
                    </div>
                </div>
                
                <!-- 3. Experience & Skills Section -->
                <h2 class="form-section-title">Experience & Skills</h2>
                
                <div class="form-group">
                    <label for="tech-stack">Primary Tech Stack*</label>
                    <select id="primary-tech" required>
                        <option value="">Select your primary technology</option>
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="csharp">C#</option>
                        <option value="ruby">Ruby</option>
                        <option value="php">PHP</option>
                        <option value="swift">Swift</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tech-stack">Additional Technologies You Plan to Use*</label>
                    <textarea id="tech-stack" rows="3" required></textarea>
                    <small>Separate technologies with commas (e.g. React, Firebase, Node.js)</small>
                </div>
                
                <div class="form-group">
                    <label>Do you have prior hackathon experience?*</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="hackathon-experience" value="yes" required> Yes
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="hackathon-experience" value="no"> No
                        </label>
                    </div>
                </div>
                
                <div id="past-hackathons-field" style="display: none;">
                    <div class="form-group">
                        <label for="past-hackathons">Past hackathons and projects</label>
                        <textarea id="past-hackathons" rows="4" placeholder="Hackathon name - Project name - Brief description"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="preferred-role">Preferred Role in Team*</label>
                    <select id="preferred-role" required>
                        <option value="">Select your preferred role</option>
                        <option value="frontend">Frontend Developer</option>
                        <option value="backend">Backend Developer</option>
                        <option value="fullstack">Full Stack Developer</option>
                        <option value="uiux">UI/UX Designer</option>
                        <option value="aiml">AI/ML Engineer</option>
                        <option value="devops">DevOps Engineer</option>
                        <option value="pm">Project Manager</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="experience-level">Your Experience Level*</label>
                    <select id="experience-level" required>
                        <option value="">Select experience level</option>
                        <option value="beginner">Beginner (First hackathon)</option>
                        <option value="intermediate">Intermediate (1-3 hackathons)</option>
                        <option value="advanced">Advanced (4+ hackathons)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bio">Short bio or "Why do you want to participate in this hackathon?"*</label>
                    <textarea id="bio" rows="4" required></textarea>
                    <small>Maximum 250 words</small>
                </div>
                
                <!-- 4. Project Proposal Section -->
                <h2 class="form-section-title">Project Proposal</h2>
                
                <div class="form-group">
                    <label>Do you have a project idea?*</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="has-project-idea" value="yes" required> Yes
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="has-project-idea" value="no"> No
                        </label>
                    </div>
                </div>
                
                <div id="project-idea-fields" style="display: none;">
                    <div class="form-group">
                        <label for="project-idea">Project Idea*</label>
                        <textarea id="project-idea" rows="5"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Are you open to joining another team's idea?*</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="join-others" value="yes" required> Yes
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="join-others" value="no"> No
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="additional-info">Additional Information</label>
                    <textarea id="additional-info" rows="3"></textarea>
                    <small>Anything else you'd like the organizers to know</small>
                </div>
                
                <button type="submit" class="submit-btn">Submit Application</button>
            </form>
        </section>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOmgh-bwztV2Ikuca2KqCjeZFQmVEOPjs",
            authDomain: "codehive-bcd90.firebaseapp.com",
            projectId: "codehive-bcd90",
            storageBucket: "codehive-bcd90.appspot.com",
            messagingSenderId: "300677091996",
            appId: "1:300677091996:web:c47af18d9e43f3355fd359"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Get hackathon ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const hackathonId = urlParams.get('hackathonId');
        
        if (!hackathonId) {
            alert('No hackathon specified');
            window.location.href = 'index.html'; // Redirect to main page if no hackathon ID
        }

        // DOM Elements
        const hackathonTitle = document.getElementById('hackathon-title');
        const applicationForm = document.getElementById('application-form');
        const teamFields = document.getElementById('team-fields');
        const pastHackathonsField = document.getElementById('past-hackathons-field');
        const projectIdeaFields = document.getElementById('project-idea-fields');

        // Toggle conditional fields based on radio button selections
        document.querySelectorAll('input[name="application-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                teamFields.style.display = this.value === 'team' ? 'block' : 'none';
                
                // Make team fields required only if team option is selected
                const teamInputs = teamFields.querySelectorAll('input, select, textarea');
                teamInputs.forEach(input => {
                    input.required = this.value === 'team';
                });
            });
        });

        document.querySelectorAll('input[name="hackathon-experience"]').forEach(radio => {
            radio.addEventListener('change', function() {
                pastHackathonsField.style.display = this.value === 'yes' ? 'block' : 'none';
            });
        });

        document.querySelectorAll('input[name="has-project-idea"]').forEach(radio => {
            radio.addEventListener('change', function() {
                projectIdeaFields.style.display = this.value === 'yes' ? 'block' : 'none';
                
                // Make project idea field required only if Yes is selected
                const projectIdeaTextarea = document.getElementById('project-idea');
                if (projectIdeaTextarea) {
                    projectIdeaTextarea.required = this.value === 'yes';
                }
            });
        });

        // Check if user is signed in
        auth.onAuthStateChanged(user => {
            if (!user) {
                console.log("User not logged in at apply.html");
                alert('Please sign in to apply for hackathons');
                window.location.href = 'login.html?redirect=apply.html?hackathonId=' + hackathonId;
            } else {
                console.log("User logged in at apply.html:", user.email);
                
                // Auto-fill email from user account
                const emailInput = document.getElementById('email');
                if (emailInput && user.email) {
                    emailInput.value = user.email;
                }
                
                // User is logged in, proceed with checking if they're a participant
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (!doc.exists || doc.data().role !== 'participant') {
                            alert('Only participants can apply to hackathons');
                            window.location.href = 'index.html';
                            return;
                        }
                        
                        // Check if they've already applied
                        return db.collection('applications')
                            .where('hackathonId', '==', hackathonId)
                            .where('userId', '==', user.uid)
                            .get();
                    })
                    .then((snapshot) => {
                        if (snapshot && !snapshot.empty) {
                            alert('You have already applied to this hackathon');
                            window.location.href = 'participant-dashboard.html';
                            return;
                        }
                        
                        // Fetch hackathon details
                        return db.collection('hackathons').doc(hackathonId).get();
                    })
                    .then((doc) => {
                        if (doc && !doc.exists) {
                            alert('Hackathon not found');
                            window.location.href = 'index.html';
                            return;
                        }
                        
                        if (doc) {
                            const hackathon = doc.data();
                            hackathonTitle.textContent = `Apply for: ${hackathon.title}`;
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again later.');
                    });
            }
        });

        // Handle form submission
      // Replace the existing form submission handler with this updated code
// Handle form submission
// Handle form submission
applicationForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) {
        alert('Please sign in to apply');
        return;
    }
    
    const submitBtn = document.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
        // Get form data
        const fullName = document.getElementById('full-name').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const linkedin = document.getElementById('linkedin').value.trim();
        const github = document.getElementById('github').value.trim();
        
        // Get resume file
        const resumeFile = document.getElementById('resume').files[0];
        let resumeData = null;
        
        // Convert file to Base64 if file is selected
        if (resumeFile) {
            // Size check (limit file size to 2MB)
            if (resumeFile.size > 2 * 1024 * 1024) {
                alert('Resume file is too large. Please upload a file smaller than 2MB.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Application';
                return;
            }
            
            resumeData = await readFileAsBase64(resumeFile);
        }
        
        // Get team information
        const applicationType = document.querySelector('input[name="application-type"]:checked').value;
        let teamName = "";
        let teamSize = "";
        let teamMembers = "";
        
        if (applicationType === 'team') {
            teamName = document.getElementById('team-name').value.trim();
            teamSize = document.getElementById('team-size').value;
            teamMembers = document.getElementById('team-members').value.trim();
        }
        
        // Get experience and skills
        const primaryTech = document.getElementById('primary-tech').value;
        const techStack = document.getElementById('tech-stack').value.trim().split(',').map(tech => tech.trim());
        const hasHackathonExperience = document.querySelector('input[name="hackathon-experience"]:checked').value;
        const pastHackathons = hasHackathonExperience === 'yes' ? document.getElementById('past-hackathons').value.trim() : "";
        const preferredRole = document.getElementById('preferred-role').value;
        const experienceLevel = document.getElementById('experience-level').value;
        const bio = document.getElementById('bio').value.trim();
        
        // Get project proposal
        const hasProjectIdea = document.querySelector('input[name="has-project-idea"]:checked').value;
        const projectIdea = hasProjectIdea === 'yes' ? document.getElementById('project-idea').value.trim() : "";
        const joinOthers = document.querySelector('input[name="join-others"]:checked').value;
        const additionalInfo = document.getElementById('additional-info').value.trim();
        
        // Get hackathon details
        const hackathonDoc = await db.collection('hackathons').doc(hackathonId).get();
        if (!hackathonDoc.exists) {
            throw new Error('Hackathon not found');
        }
        const hackathonData = hackathonDoc.data();
        
        // Create unique application ID
        const applicationId = user.uid + '_' + hackathonId;
        
        // Create application data object
        const applicationData = {
            applicationId: applicationId,
            userId: user.uid,
            hackathonId: hackathonId,
            hackathonTitle: hackathonData.title,
            
            // Personal Information
            fullName: fullName,
            email: email,
            phone: phone,
            linkedin: linkedin,
            github: github,
            
            // Resume data (stored as Base64 instead of URL)
            resumeFile: resumeFile ? {
                name: resumeFile.name,
                type: resumeFile.type,
                size: resumeFile.size,
                data: resumeData
            } : null,
            
            // Team Information
            applicationType: applicationType,
            teamName: teamName,
            teamSize: teamSize ? parseInt(teamSize) : null,
            teamMembers: teamMembers,
            
            // Experience & Skills
            primaryTech: primaryTech,
            techStack: techStack,
            hasHackathonExperience: hasHackathonExperience === 'yes',
            pastHackathons: pastHackathons,
            preferredRole: preferredRole,
            experienceLevel: experienceLevel,
            bio: bio,
            
            // Project Proposal
            hasProjectIdea: hasProjectIdea === 'yes',
            projectIdea: projectIdea,
            joinOthers: joinOthers === 'yes',
            additionalInfo: additionalInfo,
            
            // Application Status
            status: 'pending',
            createdAt: firebase.firestore.Timestamp.now(),
            updatedAt: firebase.firestore.Timestamp.now()
        };
        
        // Save to 'applications' collection
        console.log('Saving to applications collection...', applicationId);
        await db.collection('applications').doc(applicationId).set(applicationData);
        console.log('Successfully saved to applications collection');
        
        // Save to 'submitapplication' collection
        console.log('Saving to submitapplication collection...');
        await db.collection('submitapplication').add(applicationData);
        console.log('Successfully saved to submitapplication collection');
        
        alert('Application submitted successfully!');
        window.location.href = "participant-dashboard.html";
        
    } catch (error) {
        console.error('Error submitting application:', error);
        alert('Error submitting application: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
    }
});

// Helper function to read file as Base64
function readFileAsBase64(file) {
    return new Promise(function(resolve, reject) {
        const reader = new FileReader();
        reader.onload = function() {
            resolve(reader.result);
        };
        reader.onerror = function() {
            reject(reader.error);
        };
        reader.readAsDataURL(file);
    });
}
    </script>
</body>
</html>